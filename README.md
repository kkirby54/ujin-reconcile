# 미수미지급금 대조 시스템

ERP 미수미지급금 잔액과 은행 거래내역을 정확히 매칭하여 Upload_form.xlsx 형식의 일반전표 파일을 생성하는 웹 시스템입니다.

## 기능

- **웹 인터페이스**: 브라우저에서 직접 파일 업로드 및 결과 다운로드
- **Upload_form.xlsx 형식 출력**: 템플릿 서식을 보존한 전표 파일 생성
- **지능형 매칭**: 정규화 + 유사도 기반 거래처 매칭 (80% 이상 유사도)
- **다양한 파일 형식 지원**: Excel (.xlsx, .xls), CSV 파일 지원
- **자동 전표 생성**: 입출금 구분에 따른 차변/대변 금액 자동 설정
- **매칭 실패 추적**: 매칭되지 않은 거래는 별도 시트로 분리
- **드래그 앤 드롭**: 직관적인 파일 업로드 인터페이스
- **실시간 통계**: 매칭 성공/실패 건수 실시간 표시

## 프로젝트 구조

```
howmuch/
├── app/
│   ├── __init__.py
│   ├── main.py              # FastAPI 애플리케이션
│   └── core/
│       ├── __init__.py
│       ├── normalize.py     # 이름 정규화 및 유사도 매칭
│       ├── reader.py        # 파일 파서
│       └── generator.py     # Upload_form.xlsx 생성기
├── static/                  # 웹 인터페이스 정적 파일
│   ├── index.html           # 메인 웹 페이지
│   ├── css/
│   │   └── style.css        # 스타일시트
│   └── js/
│       └── app.js           # JavaScript 애플리케이션
├── Upload_form.xlsx         # 전표 템플릿 파일
├── pyproject.toml           # 프로젝트 설정
└── README.md
```

## 설치 및 실행

### 1. 의존성 설치

```bash
pip install -e .
```

### 2. 서버 실행

```bash
uvicorn app.main:app --reload
```

서버가 `http://localhost:8000`에서 실행됩니다.

### 3. 웹 인터페이스 사용

브라우저에서 `http://localhost:8000`에 접속:

1. **파일 업로드**: ERP 파일과 은행 파일을 드래그 앤 드롭 또는 클릭하여 업로드
2. **전표 생성**: "전표 생성" 버튼 클릭
3. **결과 확인**: 매칭 성공/실패 통계 확인
4. **파일 다운로드**: Upload_form.xlsx 형식의 전표 파일 다운로드

## API 사용법

### POST /reconcile

ERP 미수미지급금 파일과 은행 거래내역 파일을 업로드하여 Upload_form.xlsx 형식의 전표를 생성합니다.

**요청:**
- Content-Type: `multipart/form-data`
- Parameters:
  - `erp`: ERP 미수미지급금 파일 (Excel)
  - `bank`: 은행 거래내역 파일 (Excel/CSV)

**응답:**
- Content-Type: `application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`
- 파일명: `upload_form.xlsx`
- Headers:
  - `X-Match-Count`: 매칭 성공 건수
  - `X-Unmatch-Count`: 매칭 실패 건수
  - `X-Total-Count`: 전체 거래 건수

**예시:**
```bash
curl -X POST "http://localhost:8000/reconcile" \
  -F "erp=@erp.xlsx" \
  -F "bank=@bank.xls" \
  --output upload_form.xlsx
```

## 입력 파일 형식

### ERP 미수미지급금 파일

필수 컬럼:
- `코드`: 거래처 코드
- `거래처명`: 거래처명

시스템은 자동으로 "코드"와 "거래처"가 포함된 헤더 행을 찾습니다.

### 은행 거래내역 파일

**파일 구조**: 1~6행은 계좌 정보 등 메타데이터, 7행부터 실제 거래 데이터 시작

필수 컬럼 (7행부터):
- `거래일시`: 거래일시 (YYYY.MM.DD HH:MM:SS 형식)
- `입금액(원)`: 입금 금액 (쉼표 제거 후 숫자로 변환)
- `출금액(원)`: 출금 금액 (쉼표 제거 후 숫자로 변환)
- `보낸분/받는분`: 거래 상대방

선택 컬럼:
- `적요`: 거래 메모

## 출력 파일 형식

생성되는 `upload_form.xlsx` 파일은 Upload_form.xlsx 템플릿을 기반으로 합니다:

### 1. 일반전표 시트

매칭된 거래를 전표 형태로 변환한 데이터 (13행부터 입력):
- 순번: 1부터 순차 증가
- 거래일: 은행 거래일자
- 전표구분: 입금=2, 출금=1
- 코드/거래처명: ERP에서 매칭된 정보
- 적요: 은행 메모
- 결제장부: 2 (예금) 고정
- 금액: 거래 금액
- 차변금액: 입금 시 금액
- 대변금액: 출금 시 금액
- 메모: 은행 메모
- 프로젝트/은행코드: 빈 값

### 2. Unmatched 시트

매칭되지 않은 거래 목록:
- 거래일자, 입출금구분, 금액, 보낸분/받는분, 메모, 사유

## 지능형 매칭 시스템

### 정규화 규칙

거래처명 매칭을 위해 다음과 같은 정규화를 수행합니다:

1. **Unicode 정규화 (NFKC)**: 한글 자모 정규화
2. **공백 제거 및 소문자 변환**: 대소문자 통일
3. **회사명 키워드 제거**: "(주)", "주식회사", "㈜", "유한회사", "co", "co.", "co.,ltd", "inc", "ltd", "llc", "company"
4. **특수문자 제거**: 괄호, 하이픈, 슬래시, 숫자 제거
5. **최종 정리**: 한글, 영문만 유지

**정규화 예시:**
- `(주)해피엘앤비(H` → `해피엘앤비`
- `주식회사 유진파레트` → `유진파레트`
- `ABC Co., Ltd.` → `abc`

### 한글 유사도 매칭

- **한글 자모 분해**: 한글을 초성, 중성, 종성으로 분해하여 정밀한 유사도 계산
- **Levenshtein Distance**: 자모 시퀀스 기반 편집 거리 계산
- **임계값**: 80% 이상 유사도에서 자동 매칭
- **우선순위**: 완전일치 → 한글 유사도 → 기본 유사도 → 매칭 실패

**매칭 예시:**
- `해피엘엔비` vs `(주)해피엘앤비(H` → 한글 자모 유사도로 높은 매칭
- `(주)충북프라스틱` vs `(주)충북프라스` → 자모 분해 기반 유사도 매칭
- `주식회사 유진파레트` → `유진파레트` (100% 매칭)
- `ABC Co., Ltd.` → `abc` (100% 매칭)

**한글 자모 분해 예시:**
- `해피엘앤비` → `ㅎㅐㅍㅣㅇㅓㄹㅇㅐㄴㅂㅣ`
- `해피엘엔비` → `ㅎㅐㅍㅣㅇㅓㄹㅇㅔㄴㅂㅣ`
- 두 자모 시퀀스의 편집 거리로 유사도 계산

## 오류 처리

- **400 Bad Request**: 파일 읽기 실패, 필수 컬럼 누락
- **500 Internal Server Error**: 엑셀 파일 생성 실패
- **JSON 응답**: `{"error": "오류 메시지", "details": "상세 정보"}`

## 개발 정보

- Python 3.10+ 필요
- 주요 의존성: FastAPI, pandas, openpyxl, xlrd, regex, uvicorn
- 지능형 유사도 매칭 (한글 자모 분해 기반)

## 라이선스

MIT License
